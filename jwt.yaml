swagger: '2.0'
info:
  title: Branches-jwt
  x-ibm-name: branches-jwt
  version: 1.0.0
host: $(catalog.host)
schemes:
  - https
basePath: /branches
produces:
  - application/json
consumes:
  - application/json
securityDefinitions:
  clientIdHeader:
    type: apiKey
    in: header
    name: X-IBM-Client-Id
x-ibm-configuration:
  phase: realized
  testable: true
  enforced: true
  properties:
    target-url:
      value: 'https://apim-services.mybluemix.net/banka/v1/branches'
      description: The URL of the target service
      encoded: false
  cors:
    enabled: true
  application-authentication:
    certificate: false
  assembly:
    execute:
      - switch:
          title: switch
          case:
            - condition: request.authorization.indexOf("Bearer") > -1
              execute:
                - set-variable:
                    title: set-variable
                    actions:
                      - set: hs256key
                        value: >-
                          {   "kty": "oct",   "use": "sig",   "kid":
                          "skhynix",   "k":
                          "um5YuPomr9SSt58IIxV23o4F1bpEb6VevNqrFJsJOc1TAweRZj-PS-65dquqwYYWHerPjNfJ-IurLCx6a9JWBIkrbElrqwcapJRIaD8Tq3yUk-y6j-_Mfo6mEqPN9TnVFWf9K62UzVXfHAiZHj6jZku082sEw6jFSQ4DhwksuHgGswsAdEV05AjVuqVYjDXfujbX5G5ruTomJQExniA06QNlSE6PPxlOkh7W4XY-fQBZmjGVUa8S4Oh5AnxGGM1VmU5x9QfACD3pyzKnCciyFR0hXKX8BNUIxdTwZGnVB5f6-aQDf_helnPQuQ7A-z82XBe7vQqJA1D0fyDmLG1ZAA",  
                          "alg": "HS256" }
                    version: 1.0.0
                - gatewayscript:
                    title: gatewayscript
                    version: 1.0.0
                    source: >-
                      var authNode =
                      apim.getvariable('request.headers.authorization');


                      apim.setvariable('input-jwt', authNode.replace(/^Bearer
                      /g, ''));
                - jwt-validate:
                    title: jwt-validate
                    jwt: input-jwt
                    output-claims: decoded.claims
                    version: 1.0.0
                    jws-jwk: hs256key
                - proxy:
                    title: proxy
                    version: 1.0.0
                    verb: keep
                    target-url: $(target-url)
            - otherwise:
                - set-variable:
                    title: set-variable
                    actions:
                      - set: message.status.code
                        value: '401'
                      - set: message.status.reason
                        value: No Token Provided
                      - set: message.body
                        value: '{"message": "Authentication error."}'
                    version: 1.0.0
                - gatewayscript:
                    title: gatewayscript
                    version: 1.0.0
                    source: >-
                      apim.setvariable('message.body',apim.getvariable('jwt-validate.error-message'));   
          version: 1.0.0
          description: ''
    catch: []
  gateway: datapower-gateway
  type: rest
definitions:
  branch:
    type: object
    properties:
      address:
        $ref: '#/definitions/address'
        properties: {}
        description: The address of the branch
      type:
        type: string
        description: The type of branch
        example: atm
      id:
        properties: {}
        description: The ID of the branch
        example: 9d72ece0-7e7b-11e5-9038-55f9f9c08c06
  address:
    type: object
    properties:
      street1:
        type: string
        description: The first line of the address
        example: 4660 La Jolla Village Drive
      street2:
        type: string
        description: The second line of the address
        example: Suite 300
      city:
        type: string
        description: The city of the address
        example: San Diego
      state:
        type: string
        description: The state of the address
        example: CA
      zip_code:
        type: string
        description: The zip code of the address
        example: '92122'
paths:
  /details:
    get:
      responses:
        '200':
          description: ''
          schema:
            $ref: '#/definitions/branch'
      consumes: []
      produces: []
      parameters: []
